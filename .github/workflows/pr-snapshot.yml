name: PR Snapshot Build

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
    - master

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  GITHUB_USER: ${{ github.actor }}

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      has_code_changes: ${{ steps.changes.outputs.has_code_changes }}
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Detect code changes (exclude .md files)
      id: changes
      run: |
        # Fetch the base branch
        git fetch origin ${{ github.event.pull_request.base.ref }}

        # Get list of changed files compared to base branch, excluding .md files
        CHANGED_FILES=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD | grep -v '\.md$')

        echo "Changed files (excluding .md):"
        echo "$CHANGED_FILES"

        # Check if any code files changed
        if [ -n "$CHANGED_FILES" ]; then
          echo "has_code_changes=true" >> $GITHUB_OUTPUT
          echo "âœ… Code changes detected"
        else
          echo "has_code_changes=false" >> $GITHUB_OUTPUT
          echo "âŒ Only documentation changes, skipping build"
        fi

  skip-workflow:
    needs: detect-changes
    if: needs.detect-changes.outputs.has_code_changes == 'false'
    runs-on: ubuntu-latest
    steps:
    - name: No code changes
      run: echo "Only .md files changed, skipping workflow"

  generate-version:
    needs: detect-changes
    if: needs.detect-changes.outputs.has_code_changes == 'true'
    runs-on: ubuntu-latest
    outputs:
      snapshot_version: ${{ steps.version.outputs.snapshot }}
    steps:
    - uses: actions/checkout@v4
    - name: Fetch history
      run: git fetch --unshallow
    - name: Generate snapshot version
      id: version
      run: |
        PR_NUMBER=${{ github.event.pull_request.number }}
        
        # Calculate increment based on commits in this PR
        INCREMENT=$(git rev-list --count origin/${{ github.event.pull_request.base.ref }}...HEAD)
        
        # Use a base version that will work for all apps (use the latest tag as reference)
        # For snapshot builds, we use a simple format: pr-{number}.{increment}
        SNAPSHOT="pr-${PR_NUMBER}.${INCREMENT}"
        
        echo "snapshot=${SNAPSHOT}" >> $GITHUB_OUTPUT
        echo "Generated version: ${SNAPSHOT} (PR #${PR_NUMBER}, increment ${INCREMENT})"

  test-api:
    needs: [detect-changes, generate-version]
    if: needs.detect-changes.outputs.has_code_changes == 'true'
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'
        cache: true
        cache-dependency-path: apps/api/go.sum
    - name: Run tests
      working-directory: ./apps/api
      run: go test ./...

  test-client:
    needs: [detect-changes, generate-version]
    if: needs.detect-changes.outputs.has_code_changes == 'true'
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: "3.35.4"
        channel: "stable"
    - name: Create .env file
      working-directory: ./apps/client
      run: |
        cat << EOF > .env
        API_BASE_URL=http://localhost:8080
        GOOGLE_CLIENT_ID=mock-client-id
        APP_VERSION=${{ needs.generate-version.outputs.snapshot_version }}
        EOF
    - name: Install dependencies
      working-directory: ./apps/client
      run: flutter pub get
    - name: Generate localizations
      working-directory: ./apps/client
      run: flutter gen-l10n
    - name: Run tests
      working-directory: ./apps/client
      run: flutter test

  test-admin:
    needs: [detect-changes, generate-version]
    if: needs.detect-changes.outputs.has_code_changes == 'true'
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: apps/admin/package-lock.json
    - name: Install dependencies
      working-directory: ./apps/admin
      run: npm ci
    - name: Run tests
      working-directory: ./apps/admin
      run: npm test

  build-api:
    needs: [detect-changes, generate-version, test-api]
    if: needs.detect-changes.outputs.has_code_changes == 'true'
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    - name: Build and push API
      uses: docker/build-push-action@v5
      with:
        context: ./apps/api
        file: ./apps/api/Dockerfile
        push: true
        tags: |
          ghcr.io/${{ github.repository }}/api:${{ needs.generate-version.outputs.snapshot_version }}
          ghcr.io/${{ github.repository }}/api:pr-${{ github.event.pull_request.number }}-latest
        cache-from: type=gha
        cache-to: type=gha,mode=max

  build-client:
    needs: [detect-changes, generate-version, test-client]
    if: needs.detect-changes.outputs.has_code_changes == 'true'
    runs-on: ubuntu-latest
    environment: dev
    steps:
    - uses: actions/checkout@v4
    - name: Create .env file
      working-directory: ./apps/client
      run: |
        cat << EOF > .env
        API_BASE_URL=${{ vars.CLIENT_API_BASE_URL }}
        GOOGLE_CLIENT_ID=${{ vars.CLIENT_GOOGLE_CLIENT_ID }}
        APP_VERSION=${{ needs.generate-version.outputs.snapshot_version }}
        EOF
        echo "âœ… Created .env file for development build"
    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: "3.35.4"
        channel: "stable"
    - name: Setup Java 17
      uses: actions/setup-java@v3
      with:
        distribution: "zulu"
        java-version: "17"
        cache: "gradle"
    - name: Install dependencies
      working-directory: ./apps/client
      run: flutter pub get
    - name: Generate localizations
      working-directory: ./apps/client
      run: flutter gen-l10n
    - name: Build APK
      working-directory: ./apps/client
      run: flutter build apk --debug
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: alacarte-client-${{ needs.generate-version.outputs.snapshot_version }}
        path: apps/client/build/app/outputs/flutter-apk/app-debug.apk
        retention-days: 30

  build-admin:
    needs: [detect-changes, generate-version, test-admin]
    if: needs.detect-changes.outputs.has_code_changes == 'true'
    runs-on: ubuntu-latest
    environment: dev
    steps:
    - uses: actions/checkout@v4
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    - name: Build and push Admin
      uses: docker/build-push-action@v5
      with:
        context: ./apps/admin
        file: ./apps/admin/Dockerfile
        push: true
        target: prod
        build-args: |
          NEXT_PUBLIC_API_URL=${{ vars.ADMIN_NEXT_PUBLIC_API_URL }}
        tags: |
          ghcr.io/${{ github.repository }}/admin:${{ needs.generate-version.outputs.snapshot_version }}
          ghcr.io/${{ github.repository }}/admin:pr-${{ github.event.pull_request.number }}-latest
        cache-from: type=gha
        cache-to: type=gha,mode=max

  comment-pr:
    needs: [detect-changes, generate-version, build-api, build-client, build-admin]
    if: |
      always() &&
      needs.detect-changes.outputs.has_code_changes == 'true' &&
      needs.generate-version.result == 'success' &&
      (needs.build-api.result == 'success' || needs.build-api.result == 'failure' ||
       needs.build-client.result == 'success' || needs.build-client.result == 'failure' ||
       needs.build-admin.result == 'success' || needs.build-admin.result == 'failure')
    runs-on: ubuntu-latest
    steps:
    - name: Find and update existing comment
      uses: actions/github-script@v7
      with:
        script: |
          const version = '${{ needs.generate-version.outputs.snapshot_version }}';
          const prNumber = ${{ github.event.pull_request.number }};
          const sha = '${{ github.sha }}'.substring(0, 7);
          const runId = '${{ github.run_id }}';
          const repo = '${{ github.repository }}';

          let comment = `## ðŸ“¦ Snapshot Build Available\n\n`;
          comment += `**Version:** \`${version}\`\n`;
          comment += `**Commit:** ${sha}\n`;
          comment += `**Build:** [View Details](https://github.com/${repo}/actions/runs/${runId})\n\n`;
          comment += `### Build Status\n\n`;

          // API build status
          if ('${{ needs.build-api.result }}' === 'success') {
            comment += `âœ… **API:** \`ghcr.io/${repo}/api:${version}\`\n`;
            comment += `   - Convenience: \`ghcr.io/${repo}/api:pr-${prNumber}-latest\`\n\n`;
          } else if ('${{ needs.build-api.result }}' === 'failure') {
            comment += `âŒ **API:** Build failed\n\n`;
          }

          // Client build status
          if ('${{ needs.build-client.result }}' === 'success') {
            comment += `âœ… **Client APK:** [Download from artifacts](https://github.com/${repo}/actions/runs/${runId})\n\n`;
          } else if ('${{ needs.build-client.result }}' === 'failure') {
            comment += `âŒ **Client:** Build failed\n\n`;
          }

          // Admin build status
          if ('${{ needs.build-admin.result }}' === 'success') {
            comment += `âœ… **Admin:** \`ghcr.io/${repo}/admin:${version}\`\n`;
            comment += `   - Convenience: \`ghcr.io/${repo}/admin:pr-${prNumber}-latest\`\n\n`;
          } else if ('${{ needs.build-admin.result }}' === 'failure') {
            comment += `âŒ **Admin:** Build failed\n\n`;
          }

          // Pull commands
          comment += `### Pull Commands\n\n`;
          comment += '```bash\n';
          comment += `# API\n`;
          comment += `docker pull ghcr.io/${repo}/api:${version}\n`;
          comment += `\n# Admin\n`;
          comment += `docker pull ghcr.io/${repo}/admin:${version}\n`;
          comment += '```\n';

          // Find existing comment
          const comments = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: prNumber
          });

          const existingComment = comments.data.find(c =>
            c.body.includes('## ðŸ“¦ Snapshot Build Available') &&
            c.user.login === 'github-actions[bot]'
          );

          if (existingComment) {
            // Update existing comment
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: existingComment.id,
              body: comment
            });
            console.log('Updated existing snapshot comment');
          } else {
            // Create new comment
            await github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
            console.log('Created new snapshot comment');
          }
