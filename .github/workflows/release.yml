name: Build and Release

on:
  push:
    tags:
    - 'api-v*'
    - 'client-v*'
    - 'admin-v*'

jobs:
  build-api:
    if: startsWith(github.ref, 'refs/tags/api-v')
    runs-on: ubuntu-latest
    environment: prod
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Extract version
      id: version
      run: |
        TAG="${GITHUB_REF#refs/tags/}"
        VERSION="${TAG#api-v}"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag=$TAG" >> $GITHUB_OUTPUT

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Build and push API
      uses: docker/build-push-action@v5
      with:
        context: ./apps/api
        file: ./apps/api/Dockerfile
        push: true
        tags: |
          ${{ secrets.DOCKERHUB_USERNAME }}/alacarte-api:${{ steps.version.outputs.version }}
          ${{ secrets.DOCKERHUB_USERNAME }}/alacarte-api:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max

  build-client:
    if: startsWith(github.ref, 'refs/tags/client-v')
    runs-on: ubuntu-latest
    environment: prod
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Extract version
      id: version
      run: |
        TAG="${GITHUB_REF#refs/tags/}"
        VERSION="${TAG#client-v}"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag=$TAG" >> $GITHUB_OUTPUT

    - name: Create .env file
      working-directory: ./apps/client
      run: |
        cat << EOF > .env
        API_BASE_URL=${{ vars.CLIENT_API_BASE_URL }}
        GOOGLE_CLIENT_ID=${{ vars.CLIENT_GOOGLE_CLIENT_ID }}
        APP_VERSION=${{ steps.version.outputs.version }}
        EOF

    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: "3.35.4"
        channel: "stable"

    - name: Setup Java 17
      uses: actions/setup-java@v3
      with:
        distribution: "zulu"
        java-version: "17"
        cache: "gradle"

    - name: Setup Android Keystore
      working-directory: ./apps/client
      run: |
        echo "${{ secrets.CLIENT_KEYSTORE_BASE64 }}" | base64 -d > android/app/release-keystore.jks
        cat << EOF > android/key.properties
        storePassword=${{ secrets.CLIENT_KEYSTORE_PASSWORD }}
        keyPassword=${{ secrets.CLIENT_KEY_PASSWORD }}
        keyAlias=${{ secrets.CLIENT_KEY_ALIAS }}
        storeFile=release-keystore.jks
        EOF

    - name: Install dependencies
      working-directory: ./apps/client
      run: flutter pub get

    - name: Generate localizations
      working-directory: ./apps/client
      run: flutter gen-l10n

    - name: Build APK
      working-directory: ./apps/client
      run: flutter build apk --release

    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: client-apk-${{ steps.version.outputs.version }}
        path: apps/client/build/app/outputs/flutter-apk/app-release.apk

  build-admin:
    if: startsWith(github.ref, 'refs/tags/admin-v')
    runs-on: ubuntu-latest
    environment: prod
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Extract version
      id: version
      run: |
        TAG="${GITHUB_REF#refs/tags/}"
        VERSION="${TAG#admin-v}"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag=$TAG" >> $GITHUB_OUTPUT

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Build and push Admin
      uses: docker/build-push-action@v5
      with:
        context: ./apps/admin
        file: ./apps/admin/Dockerfile
        push: true
        target: prod
        build-args: |
          NEXT_PUBLIC_API_URL=${{ vars.ADMIN_NEXT_PUBLIC_API_URL }}
        tags: |
          ${{ secrets.DOCKERHUB_USERNAME }}/alacarte-admin:${{ steps.version.outputs.version }}
          ${{ secrets.DOCKERHUB_USERNAME }}/alacarte-admin:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max

  create-release:
    needs: [build-api, build-client, build-admin]
    if: always() && (needs.build-api.result == 'success' || needs.build-client.result == 'success' || needs.build-admin.result == 'success')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Extract tag info
      id: tag_info
      run: |
        TAG="${GITHUB_REF#refs/tags/}"
        echo "tag=$TAG" >> $GITHUB_OUTPUT

        if [[ "$TAG" =~ ^api-v ]]; then
          APP="api"
          VERSION="${TAG#api-v}"
          TITLE="API v$VERSION"
        elif [[ "$TAG" =~ ^client-v ]]; then
          APP="client"
          VERSION="${TAG#client-v}"
          TITLE="Client v$VERSION"
        elif [[ "$TAG" =~ ^admin-v ]]; then
          APP="admin"
          VERSION="${TAG#admin-v}"
          TITLE="Admin v$VERSION"
        fi

        echo "app=$APP" >> $GITHUB_OUTPUT
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "title=$TITLE" >> $GITHUB_OUTPUT

    - name: Download Client APK
      if: steps.tag_info.outputs.app == 'client'
      uses: actions/download-artifact@v4
      with:
        name: client-apk-${{ steps.tag_info.outputs.version }}
        path: ./artifacts

    - name: Generate release notes
      run: |
        APP="${{ steps.tag_info.outputs.app }}"
        VERSION="${{ steps.tag_info.outputs.version }}"

        echo "## ðŸš€ Deployment Information" > release_notes.md
        echo "" >> release_notes.md

        if [ "$APP" = "api" ]; then
          echo "### ðŸ³ Docker Image" >> release_notes.md
          echo "\`\`\`bash" >> release_notes.md
          echo "docker pull ${{ secrets.DOCKERHUB_USERNAME }}/alacarte-api:$VERSION" >> release_notes.md
          echo "\`\`\`" >> release_notes.md
          echo "" >> release_notes.md
          echo "### ðŸ“ Changelog" >> release_notes.md
          echo "See [API Changelog](./apps/api/CHANGELOG.md) for detailed changes." >> release_notes.md

        elif [ "$APP" = "client" ]; then
          echo "### ðŸ“± Android APK" >> release_notes.md
          echo "Download the APK from the assets below." >> release_notes.md
          echo "" >> release_notes.md
          echo "### ðŸ“ Changelog" >> release_notes.md
          echo "See [Client Changelog](./apps/client/CHANGELOG.md) for detailed changes." >> release_notes.md

        elif [ "$APP" = "admin" ]; then
          echo "### ðŸ³ Docker Image" >> release_notes.md
          echo "\`\`\`bash" >> release_notes.md
          echo "docker pull ${{ secrets.DOCKERHUB_USERNAME }}/alacarte-admin:$VERSION" >> release_notes.md
          echo "\`\`\`" >> release_notes.md
          echo "" >> release_notes.md
          echo "### ðŸ“ Changelog" >> release_notes.md
          echo "See [Admin Changelog](./apps/admin/CHANGELOG.md) for detailed changes." >> release_notes.md
        fi

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        name: ${{ steps.tag_info.outputs.title }}
        body_path: release_notes.md
        files: ${{ steps.tag_info.outputs.app == 'client' && './artifacts/app-release.apk' || '' }}
        draft: false
        prerelease: false
