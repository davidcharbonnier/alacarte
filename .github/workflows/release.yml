name: Build and Release

on:
  push:
    tags:
      - 'api-v*'
      - 'client-v*'
      - 'admin-v*'

jobs:
  build-api:
    if: startsWith(github.ref, 'refs/tags/api-v')
    runs-on: ubuntu-latest
    environment: prod
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract version
        id: version
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG#api-v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push API
        uses: docker/build-push-action@v5
        with:
          context: ./apps/api
          file: ./apps/api/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/alacarte-api:${{ steps.version.outputs.version }}
            ${{ secrets.DOCKERHUB_USERNAME }}/alacarte-api:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-client:
    if: startsWith(github.ref, 'refs/tags/client-v')
    runs-on: ubuntu-latest
    environment: prod
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract version
        id: version
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG#client-v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Create .env file
        working-directory: ./apps/client
        run: |
          cat << EOF > .env
          API_BASE_URL=${{ vars.CLIENT_API_BASE_URL }}
          GOOGLE_CLIENT_ID=${{ vars.CLIENT_GOOGLE_CLIENT_ID }}
          APP_VERSION=${{ steps.version.outputs.version }}
          EOF

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.35.4"
          channel: "stable"

      - name: Setup Java 17
        uses: actions/setup-java@v3
        with:
          distribution: "zulu"
          java-version: "17"
          cache: "gradle"

      - name: Setup Android Keystore
        working-directory: ./apps/client
        run: |
          echo "${{ secrets.CLIENT_KEYSTORE_BASE64 }}" | base64 -d > android/app/release-keystore.jks
          cat << EOF > android/key.properties
          storePassword=${{ secrets.CLIENT_KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.CLIENT_KEY_PASSWORD }}
          keyAlias=${{ secrets.CLIENT_KEY_ALIAS }}
          storeFile=release-keystore.jks
          EOF

      - name: Install dependencies
        working-directory: ./apps/client
        run: flutter pub get

      - name: Generate localizations
        working-directory: ./apps/client
        run: flutter gen-l10n

      - name: Build APK
        working-directory: ./apps/client
        run: flutter build apk --release

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: client-apk-${{ steps.version.outputs.version }}
          path: apps/client/build/app/outputs/flutter-apk/app-release.apk

  build-admin:
    if: startsWith(github.ref, 'refs/tags/admin-v')
    runs-on: ubuntu-latest
    environment: prod
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract version
        id: version
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG#admin-v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Admin
        uses: docker/build-push-action@v5
        with:
          context: ./apps/admin
          file: ./apps/admin/Dockerfile
          push: true
          target: prod
          build-args: |
            NEXT_PUBLIC_API_URL=${{ vars.ADMIN_NEXT_PUBLIC_API_URL }}
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/alacarte-admin:${{ steps.version.outputs.version }}
            ${{ secrets.DOCKERHUB_USERNAME }}/alacarte-admin:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  update-release:
    needs: [build-api, build-client, build-admin]
    if: (needs.build-api.result == 'success' && needs.build-api.result != 'skipped') || (needs.build-client.result == 'success' && needs.build-client.result != 'skipped') || (needs.build-admin.result == 'success' && needs.build-admin.result != 'skipped')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract tag info
        id: tag_info
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          
          if [[ "$TAG" =~ ^api-v ]]; then
            APP="api"
            VERSION="${TAG#api-v}"
            TITLE="API v$VERSION"
          elif [[ "$TAG" =~ ^client-v ]]; then
            APP="client"
            VERSION="${TAG#client-v}"
            TITLE="Client v$VERSION"
          elif [[ "$TAG" =~ ^admin-v ]]; then
            APP="admin"
            VERSION="${TAG#admin-v}"
            TITLE="Admin v$VERSION"
          fi
          
          echo "app=$APP" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "title=$TITLE" >> $GITHUB_OUTPUT

      - name: Download Client APK
        if: steps.tag_info.outputs.app == 'client'
        uses: actions/download-artifact@v4
        with:
          name: client-apk-${{ steps.tag_info.outputs.version }}
          path: ./artifacts

      - name: Read existing release notes
        id: read_release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="${{ steps.tag_info.outputs.tag }}"
          
          # Get existing release body (created by versio)
          EXISTING_BODY=$(gh release view "$TAG" --json body -q .body || echo "")
          
          # Save to file for easier handling
          echo "$EXISTING_BODY" > existing_notes.md
          
          echo "ðŸ“ Existing release notes captured"

      - name: Add deployment information
        run: |
          APP="${{ steps.tag_info.outputs.app }}"
          VERSION="${{ steps.tag_info.outputs.version }}"
          
          # Start with existing versio generated notes
          cat existing_notes.md > enhanced_notes.md
          
          echo "" >> enhanced_notes.md
          echo "---" >> enhanced_notes.md
          echo "" >> enhanced_notes.md
          echo "## ðŸš€ Deployment Information" >> enhanced_notes.md
          echo "" >> enhanced_notes.md
          
          if [ "$APP" = "api" ]; then
            echo "### ðŸ³ API Docker Image" >> enhanced_notes.md
            echo "\`\`\`bash" >> enhanced_notes.md
            echo "docker pull ${{ secrets.DOCKERHUB_USERNAME }}/alacarte-api:$VERSION" >> enhanced_notes.md
            echo "\`\`\`" >> enhanced_notes.md
            echo "" >> enhanced_notes.md
            echo "### ðŸ“ Changelog" >> enhanced_notes.md
            echo "See [API Changelog](./apps/api/CHANGELOG.md) for detailed changes." >> enhanced_notes.md
            
          elif [ "$APP" = "client" ]; then
            echo "### ðŸ“± Client APK" >>> enhanced_notes.md
            echo "Download the APK from the assets below." >> enhanced_notes.md
            echo "" >> enhanced_notes.md
            echo "### ðŸ“ Changelog" >> enhanced_notes.md
            echo "See [Client Changelog](./apps/client/CHANGELOG.md) for detailed changes." >> enhanced_notes.md
            
          elif [ "$APP" = "admin" ]; then
            echo "### ðŸ³ Admin Docker Image" >> enhanced_notes.md
            echo "\`\`\`bash" >> enhanced_notes.md
            echo "docker pull ${{ secrets.DOCKERHUB_USERNAME }}/alacarte-admin:$VERSION" >> enhanced_notes.md
            echo "\`\`\`" >> enhanced_notes.md
            echo "" >> enhanced_notes.md
            echo "### ðŸ“ Changelog" >> enhanced_notes.md
            echo "See [Admin Changelog](./apps/admin/CHANGELOG.md) for detailed changes." >> enhanced_notes.md
          fi

      - name: Update GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="${{ steps.tag_info.outputs.tag }}"
          TITLE="${{ steps.tag_info.outputs.title }}"
          
          # Update the release with enhanced notes and title
          gh release edit "$TAG" --title "$TITLE" --notes-file enhanced_notes.md
          
          echo "âœ… Release updated: $TITLE"

      - name: Upload APK to Release
        if: steps.tag_info.outputs.app == 'client'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="${{ steps.tag_info.outputs.tag }}"
          
          # Upload APK as release asset
          gh release upload "$TAG" ./artifacts/app-release.apk --clobber
          
          echo "âœ… APK uploaded to release"
