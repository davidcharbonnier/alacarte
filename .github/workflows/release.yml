name: Build and Release

on:
  push:
    tags:
      - 'api-v*'
      - 'client-v*'
      - 'admin-v*'
      - 'v*'

jobs:
  determine-releases:
    runs-on: ubuntu-latest
    outputs:
      build_api: ${{ steps.check.outputs.build_api }}
      build_client: ${{ steps.check.outputs.build_client }}
      build_admin: ${{ steps.check.outputs.build_admin }}
      api_version: ${{ steps.versions.outputs.api_version }}
      client_version: ${{ steps.versions.outputs.client_version }}
      admin_version: ${{ steps.versions.outputs.admin_version }}
      release_type: ${{ steps.check.outputs.release_type }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine what to build from tag
        id: check
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          echo "Tag: $TAG"
          
          if [[ "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            # Synchronized release (v1.2.3)
            echo "build_api=true" >> $GITHUB_OUTPUT
            echo "build_client=true" >> $GITHUB_OUTPUT
            echo "build_admin=true" >> $GITHUB_OUTPUT
            echo "release_type=synced" >> $GITHUB_OUTPUT
            echo "âœ… Synced release detected"
          elif [[ "$TAG" =~ ^api-v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            # API only
            echo "build_api=true" >> $GITHUB_OUTPUT
            echo "build_client=false" >> $GITHUB_OUTPUT
            echo "build_admin=false" >> $GITHUB_OUTPUT
            echo "release_type=api" >> $GITHUB_OUTPUT
            echo "âœ… API release detected"
          elif [[ "$TAG" =~ ^client-v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            # Client only
            echo "build_api=false" >> $GITHUB_OUTPUT
            echo "build_client=true" >> $GITHUB_OUTPUT
            echo "build_admin=false" >> $GITHUB_OUTPUT
            echo "release_type=client" >> $GITHUB_OUTPUT
            echo "âœ… Client release detected"
          elif [[ "$TAG" =~ ^admin-v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            # Admin only
            echo "build_api=false" >> $GITHUB_OUTPUT
            echo "build_client=false" >> $GITHUB_OUTPUT
            echo "build_admin=true" >> $GITHUB_OUTPUT
            echo "release_type=admin" >> $GITHUB_OUTPUT
            echo "âœ… Admin release detected"
          fi

      - name: Get versions from package.json
        id: versions
        run: |
          API_VERSION=$(node -p "require('./apps/api/package.json').version")
          CLIENT_VERSION=$(node -p "require('./apps/client/package.json').version")
          ADMIN_VERSION=$(node -p "require('./apps/admin/package.json').version")
          
          echo "api_version=$API_VERSION" >> $GITHUB_OUTPUT
          echo "client_version=$CLIENT_VERSION" >> $GITHUB_OUTPUT
          echo "admin_version=$ADMIN_VERSION" >> $GITHUB_OUTPUT
          
          echo "ðŸ“¦ Versions: API=$API_VERSION, Client=$CLIENT_VERSION, Admin=$ADMIN_VERSION"

  build-api:
    needs: determine-releases
    if: needs.determine-releases.outputs.build_api == 'true'
    runs-on: ubuntu-latest
    environment: prod
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push API
        uses: docker/build-push-action@v5
        with:
          context: ./apps/api
          file: ./apps/api/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/alacarte-api:${{ needs.determine-releases.outputs.api_version }}
            ${{ secrets.DOCKERHUB_USERNAME }}/alacarte-api:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-client:
    needs: determine-releases
    if: needs.determine-releases.outputs.build_client == 'true'
    runs-on: ubuntu-latest
    environment: prod
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create .env file
        working-directory: ./apps/client
        run: |
          cat << EOF > .env
          API_BASE_URL=${{ vars.CLIENT_API_BASE_URL }}
          GOOGLE_CLIENT_ID=${{ vars.CLIENT_GOOGLE_CLIENT_ID }}
          APP_VERSION=${{ needs.determine-releases.outputs.client_version }}
          EOF

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.35.4"
          channel: "stable"

      - name: Setup Java 17
        uses: actions/setup-java@v3
        with:
          distribution: "zulu"
          java-version: "17"
          cache: "gradle"

      - name: Setup Android Keystore
        working-directory: ./apps/client
        run: |
          echo "${{ secrets.CLIENT_KEYSTORE_BASE64 }}" | base64 -d > android/app/release-keystore.jks
          cat << EOF > android/key.properties
          storePassword=${{ secrets.CLIENT_KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.CLIENT_KEY_PASSWORD }}
          keyAlias=${{ secrets.CLIENT_KEY_ALIAS }}
          storeFile=release-keystore.jks
          EOF

      - name: Install dependencies
        working-directory: ./apps/client
        run: flutter pub get

      - name: Generate localizations
        working-directory: ./apps/client
        run: flutter gen-l10n

      - name: Build APK
        working-directory: ./apps/client
        run: flutter build apk --release

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: client-apk-${{ needs.determine-releases.outputs.client_version }}
          path: apps/client/build/app/outputs/flutter-apk/app-release.apk

  build-admin:
    needs: determine-releases
    if: needs.determine-releases.outputs.build_admin == 'true'
    runs-on: ubuntu-latest
    environment: prod
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Admin
        uses: docker/build-push-action@v5
        with:
          context: ./apps/admin
          file: ./apps/admin/Dockerfile
          push: true
          target: prod
          build-args: |
            NEXT_PUBLIC_API_URL=${{ vars.ADMIN_NEXT_PUBLIC_API_URL }}
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/alacarte-admin:${{ needs.determine-releases.outputs.admin_version }}
            ${{ secrets.DOCKERHUB_USERNAME }}/alacarte-admin:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  create-github-release:
    needs: [determine-releases, build-api, build-client, build-admin]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Client APK
        if: needs.determine-releases.outputs.build_client == 'true' && needs.build-client.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: client-apk-${{ needs.determine-releases.outputs.client_version }}
          path: ./artifacts

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: ./artifacts/app-release.apk
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
